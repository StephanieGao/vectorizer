<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Image to Matrix Converter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <main class="container">
      <h1>Image & Video Matrix Converter</h1>
      <p class="lead">
        Upload a single image or a short video to generate 50Ã—50 grayscale matrices with values scaled between 0 and 256.
      </p>

      <section class="card">
        <h2>Single Image</h2>
        <form method="post" enctype="multipart/form-data" class="upload-form">
          <input type="hidden" name="mode" value="image" />
          <label for="image">Choose an image file:</label>
          <input type="file" id="image" name="image" accept="image/*" required />
          <button type="submit">Convert Image</button>
        </form>

        {% if image_error %}
        <p class="feedback error">{{ image_error }}</p>
        {% endif %}

        {% if image_output %}
        <div class="result">
          <h3>Matrix Output</h3>
          <pre><code>{{ image_output }}</code></pre>
          <div class="result-actions">
            <form method="post" class="plot-inline-form">
              <input type="hidden" name="mode" value="plot" />
              <textarea name="matrix_text" class="sr-only" aria-hidden="true">{{ image_output }}</textarea>
              <input type="hidden" name="plot_title" value="Before Levitt" />
              <input type="hidden" name="plot_cmap" value="gray" />
              <input type="hidden" name="plot_vmin" value="0" />
              <input type="hidden" name="plot_vmax" value="255" />
              <button type="submit">Plot this matrix</button>
            </form>
          </div>
        </div>
        {% endif %}
      </section>

      <section class="card">
        <h2>Video Frames</h2>
        <form method="post" enctype="multipart/form-data" class="upload-form">
          <input type="hidden" name="mode" value="video" />
          <label for="video">Choose a video file:</label>
          <input type="file" id="video" name="video" accept="video/*" required />

          <div class="form-grid">
            <label>
              Frame skip
              <input type="number" name="frame_skip" min="1" value="1" />
              <span class="hint">Process every n-th frame</span>
            </label>
            <label>
              Max frames
              <input type="number" name="max_frames" min="1" max="{{ max_frames }}" value="10" />
              <span class="hint">Up to {{ max_frames }} frames shown</span>
            </label>
          </div>

          <button type="submit">Convert Video</button>
        </form>

        {% if video_error %}
        <p class="feedback error">{{ video_error }}</p>
        {% endif %}

        {% if video_outputs %}
        <div class="result">
          <h3>Frame Matrices</h3>
          <p class="hint">Showing {{ video_outputs|length }} converted frames.</p>
          <div class="frame-list">
            {% for frame in video_outputs %}
            <details>
              <summary>{{ frame.label }}</summary>
              <pre><code>{{ frame.matrix }}</code></pre>
              <div class="result-actions">
                <form method="post" class="plot-inline-form">
                  <input type="hidden" name="mode" value="plot" />
                  <textarea name="matrix_text" class="sr-only" aria-hidden="true">{{ frame.matrix }}</textarea>
                  <input type="hidden" name="plot_title" value="{{ frame.label }}" />
                  <input type="hidden" name="plot_cmap" value="gray" />
                  <input type="hidden" name="plot_vmin" value="0" />
                  <input type="hidden" name="plot_vmax" value="255" />
                  <button type="submit">Plot this matrix</button>
                </form>
              </div>
            </details>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </section>

      <section class="card">
        <h2>Matrix Plotter</h2>
        <p class="hint">Paste any Sage-style matrix (e.g. the output above) and preview it using a grayscale colormap.</p>
        <form method="post" class="upload-form">
          <input type="hidden" name="mode" value="plot" />
          <label for="matrix_text">Matrix values</label>
          <textarea
            id="matrix_text"
            name="matrix_text"
            class="matrix-textarea"
            placeholder="M = matrix([ ... ])"
            required
          >{{ plot_form.matrix_text }}</textarea>

          <div class="form-grid">
            <label>
              Title
              <input type="text" name="plot_title" value="{{ plot_form.plot_title }}" />
            </label>
            <label>
              Colormap
              <select name="plot_cmap">
                {% for value, label in plot_cmaps %}
                <option value="{{ value }}" {% if value == plot_form.plot_cmap %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              Min (vmin)
              <input type="number" step="any" name="plot_vmin" value="{{ plot_form.plot_vmin }}" />
              <span class="hint">Leave blank to auto-detect</span>
            </label>
            <label>
              Max (vmax)
              <input type="number" step="any" name="plot_vmax" value="{{ plot_form.plot_vmax }}" />
              <span class="hint">Leave blank to auto-detect</span>
            </label>
          </div>

          <button type="submit">Plot Matrix</button>
        </form>

        {% if plot_error %}
        <p class="feedback error">{{ plot_error }}</p>
        {% endif %}

        {% if plot_result %}
        <div class="result plot-preview">
          <h3>{{ plot_result.title }}</h3>
          <img src="{{ plot_result.data_url }}" alt="Matrix plot preview" class="plot-image" />
          <a class="download-link" href="{{ plot_result.data_url }}" download="matrix-plot.png">Download PNG</a>
        </div>
        {% endif %}
      </section>
    </main>
  </body>
</html>
